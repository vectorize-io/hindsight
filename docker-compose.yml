services:
    postgres:
        image: pgvector/pgvector:pg17
        container_name: hindsight-postgres
        restart: unless-stopped
        environment:
            POSTGRES_USER: hindsight
            POSTGRES_PASSWORD: hindsight
            POSTGRES_DB: hindsight
        volumes:
            - hindsight_pgdata:/var/lib/postgresql/data
        ports:
            - "5437:5432"
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U hindsight -d hindsight"]
            interval: 5s
            timeout: 5s
            retries: 5

    hindsight:
        # image: ghcr.io/vectorize-io/hindsight:latest
        image: hindsight:latest
        container_name: hindsight
        build:
            context: .
            dockerfile: docker/standalone/Dockerfile
        tty: true
        stdin_open: true
        restart: unless-stopped
        depends_on:
            postgres:
                condition: service_healthy
        ports:
            - "8886:8888"
            - "9999:9999"
        environment:
            HINDSIGHT_API_LLM_API_KEY: ${HINDSIGHT_API_LLM_API_KEY}
            HINDSIGHT_API_DATABASE_URL: postgresql://hindsight:hindsight@postgres:5432/hindsight
            HINDSIGHT_API_LLM_MODEL: ${HINDSIGHT_API_LLM_MODEL}
            HINDSIGHT_API_LLM_BASE_URL: ${HINDSIGHT_API_LLM_BASE_URL}

volumes:
    hindsight_pgdata:
